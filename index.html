<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Board Game Quick Menus</title>
<link rel="icon" type="image/png" href="./favicon.png" />

<!-- Typography -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@700&display=swap" rel="stylesheet">

<!-- Preload logo -->
<link rel="preload" href="./logo.png" as="image">

<style>
  :root {
    --brand:#0b63ff;
    --bg:#f6f7fb;
    --fg:#111111;
    --muted:#555555;
    --card:#ffffff;
    --border:#e6e6ef;
    --btn:#ffffff;
    --btn-border:#dcdce6;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  :root[data-theme="dark"] {
    --brand:#5b8dff;
    --bg:#0f1115;
    --fg:#e8eaf0;
    --muted:#a2a8b4;
    --card:#161922;
    --border:#2a2f3a;
    --btn:#1b2030;
    --btn-border:#2a2f3a;
  }
  @media (prefers-color-scheme: dark) {
    :root:not([data-theme]) {
      --brand:#5b8dff;
      --bg:#0f1115;
      --fg:#e8eaf0;
      --muted:#a2a8b4;
      --card:#161922;
      --border:#2a2f3a;
      --btn:#1b2030;
      --btn-border:#2a2f3a;
    }
  }

  html, body { height:100%; }
  body {
    margin:0;
    background:var(--bg);
    color:var(--fg);
    -webkit-font-smoothing:antialiased;
    text-rendering:optimizeLegibility;
  }
  img { max-width:100%; height:auto; display:block; }

  h1, h2, h3 {
    font-family:"Merriweather", Georgia, "Times New Roman", serif;
  }

  header {
    position:sticky;
    top:0;
    z-index:5;
    background:var(--brand);
    color:#ffffff;
    padding:10px 14px;
    box-shadow:0 2px 12px rgba(0,0,0,0.15);
  }
  header .wrap {
    max-width:1000px;
    margin:0 auto;
    display:flex;
    gap:10px;
    align-items:center;
  }
  header h1 {
    margin:0;
    font-size:1rem;
    white-space:nowrap;
  }
  header .spacer { flex:1; }
  header button.toggle {
    appearance:none;
    border:1px solid rgba(255,255,255,0.35);
    background:transparent;
    color:#ffffff;
    border-radius:9px;
    padding:8px 10px;
    cursor:pointer;
    font-weight:600;
  }
  header a.home {
    color:#ffffff;
    text-decoration:none;
    border:1px solid rgba(255,255,255,0.35);
    border-radius:9px;
    padding:8px 10px;
  }

  .header-home-link {
    display:flex;
    align-items:center;
    gap:12px;
    text-decoration:none;
    color:inherit;
  }

  main {
    max-width:1000px;
    margin:16px auto 40px;
    padding:0 14px;
  }

  /* List view */
  #search {
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--fg);
    margin-bottom:12px;
  }
  .grid {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    gap:12px;
  }
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    text-decoration:none;
    color:inherit;
    display:flex;
    gap:10px;
    transition:transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
  }
  .card:hover {
    transform:translateY(-3px);
    box-shadow:0 6px 18px rgba(0,0,0,0.16);
    border-color:#9dbbfd;
  }
  .thumb {
    width:64px;
    height:64px;
    border-radius:8px;
    background:#00000011;
    flex:0 0 auto;
    overflow:hidden;
  }
  .thumb img {
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .metaWrap { min-width:0; }
  .card h2 {
    margin:0.1rem 0 0.25rem;
    font-size:1rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .sub {
    color:var(--muted);
    font-size:0.85rem;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* Detail view */
  .detail {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:16px;
  }

  .cover {
    border-radius:12px;
    overflow:hidden;
    background:#00000011;
    justify-self:center;
    max-width:180px;
  }
  .cover-link {
    display:block;
    position:relative;
    text-decoration:none;
  }
  .cover img {
    width:100%;
    height:auto;
    display:block;
    object-fit:contain;
    transition:transform 0.15s ease-out;
  }
  .cover-link:hover img {
    transform:scale(1.03);
  }
  .cover-badge {
    position:absolute;
    right:6px;
    bottom:6px;
    padding:3px 7px;
    border-radius:999px;
    font-size:0.7rem;
    background:rgba(0,0,0,0.65);
    color:#ffffff;
  }
  .cover-link--disabled {
    cursor:default;
  }
  .cover-link--disabled:hover img {
    transform:none;
  }
  .cover-badge--disabled {
    background:rgba(0,0,0,0.4);
    opacity:0.8;
  }

  .title {
    margin:0.2rem 0 0.25rem;
    font-size:1.2rem;
    line-height:1.2;
  }
  .byline {
    color:var(--muted);
    font-size:0.92rem;
    margin:0 0 10px;
  }

  .actions {
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:6px;
  }

  .btn,
  .btnlink {
    display:block;
    width:100%;
    text-align:center;
    padding:14px;
    border-radius:12px;
    border:1px solid var(--btn-border);
    background:var(--btn);
    color:inherit;
    text-decoration:none;
    font-weight:700;
    cursor:pointer;
    box-sizing:border-box;
  }
  .btn.primary {
    background:var(--brand);
    color:#ffffff;
    border:none;
  }

  .qs,
  .exp {
    margin-top:8px;
    padding:10px;
    border:1px dashed var(--border);
    border-radius:12px;
    background:#f0f4ff;
  }

  .exp h3 {
    margin:0.2rem 0 0.6rem;
    font-size:1.05rem;
  }
  .exp ul {
    margin:0.2rem 0 0.2rem 1.1rem;
  }

  /* Expansion details */
  .expansion {
    margin-bottom:8px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--card);
    overflow:hidden;
  }
  .expansion summary {
    cursor:pointer;
    list-style:none;
    font-weight:600;
    padding:10px 12px;
    display:flex;
    align-items:center;
    gap:8px;
    position:relative;
  }
  .expansion summary::-webkit-details-marker {
    display:none;
  }
  .expansion summary::before {
    content:">";
    font-size:0.8rem;
    transform:translateY(1px);
    margin-right:4px;
  }
  .expansion[open] summary::before {
    content:"v";
  }
  .expansion summary:hover {
    background:#e6ecff;
  }

  .expansion-body {
    padding:8px 12px 10px;
    border-top:1px solid var(--border);
    margin-top:6px;
  }
  .expansion-text-block h4 {
    margin:0.2rem 0 0.25rem;
    font-size:0.95rem;
  }
  .expansion-text-block p {
    margin:0 0 0.4rem;
    font-size:0.85rem;
    line-height:1.4;
  }
  .expansion-btns {
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-top:4px;
  }
  .expansion-name {
    font-weight:600;
  }

  .expansion-art {
    margin-bottom:8px;
  }
  .expansion-art img {
    width:100%;
    max-width:220px;
    border-radius:8px;
    display:block;
  }
/* Dark mode tuning for expansion headers */
:root[data-theme="dark"] .expansion summary {
  background: color-mix(in srgb, var(--card) 90%, var(--brand) 10%);
  color: var(--fg);
}

/* Keep hover/open state consistent in dark mode */
:root[data-theme="dark"] .expansion summary:hover,
:root[data-theme="dark"] .expansion[open] summary {
  background: color-mix(in srgb, var(--card) 85%, var(--brand) 15%);
}
/* Darken top header bar in dark mode */
:root[data-theme="dark"] header {
  background: #050816; /* or use var(--card) if you want it to blend more */
}

:root[data-theme="dark"] header .wrap h1,
:root[data-theme="dark"] header .home,
:root[data-theme="dark"] header .toggle {
  color: #ffffff;
  border-color: rgba(255, 255, 255, 0.45);
}
  /* Table notes */
  #notes-section textarea {
    font-family:inherit;
    font-size:0.9rem;
  }

  @media (max-width:840px) {
    .detail { grid-template-columns:1fr; }
    .cover { width:100%; }
  }
  /* Dark mode tuning for section borders/backgrounds */
:root[data-theme="dark"] .qs,
:root[data-theme="dark"] .exp,
:root[data-theme="dark"] .expansion {
  border-color: var(--border);
}

/* Optional: darker background in dark mode so they don't glow */
:root[data-theme="dark"] .qs,
:root[data-theme="dark"] .exp {
  background: color-mix(in srgb, var(--card) 92%, var(--brand) 8%);
}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="#/" class="header-home-link">
      <img src="./logo.png" alt="BGQuick logo" style="height: 60px;">
      <h1>Board Game Quick</h1>
    </a>

    <div class="spacer"></div>

    <button id="themeToggle" class="toggle" aria-label="Toggle dark mode">Dark/Light</button>
    <a class="home" href="#/">All Games</a>
  </div>
</header>

<main>
  <div id="app"><noscript>JavaScript required.</noscript></div>
</main>

<script id="games-json" type="application/json">
/* THIS IS WHERE MY GAMES GO */
</script>

<script>
(function() {
  /* Theme toggle */
  var root = document.documentElement;
  var saved = localStorage.getItem("theme");
  if (saved) {
    root.setAttribute("data-theme", saved);
  } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
    root.setAttribute("data-theme", "dark");
  }
  var themeBtn = document.getElementById("themeToggle");
  if (themeBtn) {
    themeBtn.addEventListener("click", function() {
      var curr = root.getAttribute("data-theme");
      var next = curr === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });
  }

  /* BG Stats helpers */
  var BGSTATS_ID_PREFIX_APP  = "bgstats://app.bgstatsapp.com/addPlay.html?gameId=";
  var BGSTATS_ID_PREFIX_WEB  = "https://bgstats.app/bgg/";
  var BGSTATS_SLUG_PREFIX_WEB = "https://bgstats.app/game/";
  function extractBggId(urlOrId) {
    if (!urlOrId) return "";
    var m = String(urlOrId).match(/([0-9]{2,})/);
    return m ? m[1] : "";
  }
  function bgstatsUrl(slug) {
    return BGSTATS_SLUG_PREFIX_WEB + slug;
  }

  /* Data */
  var RAW = JSON.parse(document.getElementById("games-json").textContent);
  function slugify(s) {
    return s.toLowerCase()
      .replace(/[:'"]/g,"")
      .replace(/&/g,"and")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/(^-|-$)/g,"");
  }
  function qp(n) {
    return new URL(window.location.href).searchParams.get(n) || "";
  }
  function basePath() {
    return window.location.pathname
      .replace(/\/index\.html$/,"")
      .replace(/\/$/,"");
  }
  function rulebookUrl(s) {
    return basePath() + "/rulebooks/" + s + ".pdf";
  }
  function remindersUrl(s) {
    return basePath() + "/reminders/" + s + ".html";
  }
  function coverUrl(slug) {
    return basePath() + "/covers/" + slug + ".webp";
  }
  function bggLinkFromId(id) {
    id = extractBggId(id);
    return id ? "https://boardgamegeek.com/boardgame/" + id : "";
  }

  var DATA = {};
  (RAW.names || []).forEach(function(name) {
    var slug = slugify(name);
    DATA[slug] = Object.assign({ name: name, slug: slug }, (RAW.enrich && RAW.enrich[slug]) || {});
  });

  var appEl = document.getElementById("app");

  function listRow(g) {
    var bits = [];
    if (g.players) bits.push(g.players);
    if (g.time) bits.push(g.time + " min");
    if (g.year) bits.push(g.year);
    var sub = bits.join(" \u2022 ");
    return (
      '<a class="card" href="#/game/' + g.slug + '">' +
        '<div class="thumb">' +
          '<img loading="lazy" src="' + coverUrl(g.slug) + '" onerror="this.parentNode.style.display=\'none\'">' +
        "</div>" +
        '<div class="metaWrap">' +
          "<h2>" + g.name + "</h2>" +
          '<p class="sub">' + sub + "</p>" +
        "</div>" +
      "</a>"
    );
  }

  function renderList() {
    appEl.innerHTML =
      '<input id="search" placeholder="Search your collection..." aria-label="Search games">' +
      '<section id="game-grid" class="grid"></section>';

    var grid = document.getElementById("game-grid");
    var search = document.getElementById("search");

    function updateGrid(filter) {
      filter = (filter || "").toLowerCase();
      var games = Object.keys(DATA)
        .map(function(k) { return DATA[k]; })
        .filter(function(g) {
          return !filter || g.name.toLowerCase().indexOf(filter) !== -1;
        })
        .sort(function(a, b) {
          return a.name.localeCompare(b.name);
        });
      grid.innerHTML = games.map(listRow).join("");
    }

    updateGrid("");

    search.addEventListener("input", function(e) {
      updateGrid(e.target.value);
    });
  }

  function expansionSlug(name) {
    return slugify(name);
  }

  function expansionRulebook(gameSlug, exp) {
    if (exp.rulebook) {
      var rb = String(exp.rulebook).trim();
      if (/^https?:\/\//i.test(rb)) return rb;
      return rulebookUrl(rb.replace(/\.pdf$/,""));
    }
    var es = expansionSlug(exp.name || "");
    return rulebookUrl((gameSlug + "--" + es).replace(/\.pdf$/,""));
  }

  function expansionCoverUrl(gameSlug, exp) {
    var bp = basePath();
    if (exp.cover) {
      var c = String(exp.cover).trim();
      if (/^https?:\/\//i.test(c)) return c;
      if (/\.(png|jpe?g|webp|gif|avif|svg)$/i.test(c)) {
        return bp + "/" + c.replace(/^\//,"");
      }
      return coverUrl(c);
    }
    var es = expansionSlug(exp.name || "");
    return coverUrl(gameSlug + "--" + es);
  }

  function renderExpansions(game) {
    var exps = Array.isArray(game.expansions) ? game.expansions : [];
    exps = exps.filter(function(exp) {
      if (!exp || typeof exp !== "object") return false;
      var name = (exp.name || "").trim();
      var hasContent = [
        exp.quickStart,
        exp.reminders,
        exp.rulebook,
        exp.youtube,
        exp.bggId,
        exp.cover
      ].some(function(v) { return v && String(v).trim() !== ""; });
      return name || hasContent;
    });
    if (!exps.length) return "";

    var blocks = exps.map(function(exp) {
      var expName = exp.name || "Expansion";
      var expRulebook = expansionRulebook(game.slug, exp);
      var cover = expansionCoverUrl(game.slug, exp);

      var expBggId = extractBggId(exp.bggId || "");
      var baseBggId = extractBggId(game.bggId || "");
      var id = expBggId || baseBggId;

      var links = {
        rulebook: expRulebook,
        youtube: exp.youtube || "",
        bgstats: id ? (BGSTATS_ID_PREFIX_WEB + id) : "",
        bgstatsApp: id ? (BGSTATS_ID_PREFIX_APP + id) : null
      };

      var qs  = (exp.quickStart || "").trim();
      var rem = (exp.reminders  || "").trim();

      return (
        '<details class="expansion">' +
          '<summary><span class="expansion-name">' + expName + "</span></summary>" +
          '<div class="expansion-body">' +
            (cover ? (
              '<div class="expansion-art">' +
                '<img src="' + cover + '" alt="' + expName + ' cover" loading="lazy">' +
              "</div>"
            ) : "") +
            (qs ? (
              '<div class="expansion-text-block"><h4>Quick Setup</h4><p>' +
              qs.replace(/\n/g,"<br>") +
              "</p></div>"
            ) : "") +
            (rem ? (
              '<div class="expansion-text-block"><h4>Quick Reminders</h4><p>' +
              rem.replace(/\n/g,"<br>") +
              "</p></div>"
            ) : "") +
            '<div class="expansion-btns">' +
              (links.rulebook ? (
                '<a class="btnlink" href="' + links.rulebook + '" target="_blank" rel="noopener">Rulebook</a>'
              ) : "") +
              (links.youtube ? (
                '<a class="btnlink" href="' + links.youtube + '" target="_blank" rel="noopener">How to Play Video</a>'
              ) : "") +
            "</div>" +
          "</div>" +
        "</details>"
      );
    }).join("");

    return (
      '<section id="exp" class="exp">' +
        "<h3>Expansions</h3>" +
        blocks +
      "</section>"
    );
  }

    /* --- Recently viewed helpers --- */
  var RECENT_KEY = "bgq_recent";

  function renderRecentlyViewed(list) {
    var section = document.getElementById("recentlyViewed");
    var container = document.getElementById("recentlyViewedList");
    if (!section || !container) return;

    container.innerHTML = "";
    if (!list || !list.length) {
      section.hidden = true;
      return;
    }

    section.hidden = false;

    list.forEach(function(item) {
      var chip = document.createElement("button");
      chip.className = "recent-chip";
      chip.type = "button";

      var img = document.createElement("img");
      img.src = item.cover;
      img.alt = item.name + " cover";

      var span = document.createElement("span");
      span.textContent = item.name;

      chip.appendChild(img);
      chip.appendChild(span);

      chip.addEventListener("click", function() {
        window.location.hash = "#/game/" + item.slug;
      });

      container.appendChild(chip);
    });
  }

  function markRecentlyViewed(game) {
    try {
      var raw = localStorage.getItem(RECENT_KEY);
      var list = raw ? JSON.parse(raw) : [];

      // Remove existing entry for this slug
      list = list.filter(function(item) { return item.slug !== game.slug; });

      // Add to front
      list.unshift({
        slug: game.slug,
        name: game.name,
        cover: coverUrl(game.slug)
      });

      if (list.length > 8) list = list.slice(0, 8);

      localStorage.setItem(RECENT_KEY, JSON.stringify(list));
      renderRecentlyViewed(list);
    } catch (e) {
      // Ignore failures
    }
  }

  // Initial render of recently viewed on load
  (function initRecentOnLoad() {
    try {
      var raw = localStorage.getItem(RECENT_KEY);
      if (raw) {
        renderRecentlyViewed(JSON.parse(raw));
      }
    } catch (e) {}
  })();

  /* --- Rulebook guard: show friendly error instead of 404 --- */
  function attachRulebookGuards() {
    var links = document.querySelectorAll('a[data-check="rulebook"]');
    links.forEach(function(link) {
      var url = link.href;
      if (!url) return;

      // Only intercept same-origin PDFs; external links just pass through
      var sameOrigin = url.indexOf(window.location.origin) === 0 || url.charAt(0) === "/";
      if (!sameOrigin) return;

      link.addEventListener("click", function handleClick(e) {
        e.preventDefault();

        fetch(url, { method: "HEAD" })
          .then(function(res) {
            if (res.ok) {
              window.open(url, "_blank", "noopener");
            } else {
              window.alert("Sorry, this rulebook has not been uploaded yet.");
            }
          })
          .catch(function() {
            window.alert("Sorry, this rulebook could not be loaded right now.");
          });

        // Only run the HEAD check once per link
        link.removeEventListener("click", handleClick);
      }, { once: true });
    });
  }
  
  function renderDetail(slug, action) {
    if (action === void 0) action = "quicksetup";

    var g = DATA[slug];
    if (!g) {
      appEl.innerHTML = '<div class="detail"><p>Game not found: <code>' + slug + "</code></p></div>";
      return;
    }

    /* --- Subline bits (players • time • year) --- */
    var bits = [];
    if (g.players) bits.push(g.players);
    if (g.time) bits.push(g.time + " min");
    if (g.year) bits.push(g.year);
    var sub = bits.join(" \u2022 ");

    /* --- Links (BGG, BG Stats, rulebook, cover) --- */
    var id = extractBggId(g.bggId);
    var links = {
      youtube: g.youtube || "",
      bgstats: id ? (BGSTATS_ID_PREFIX_WEB + id) : bgstatsUrl(slug),
      bgstatsApp: id ? (BGSTATS_ID_PREFIX_APP + id) : null,
      reminders: g.reminders || remindersUrl(slug),
      rulebook: g.rulebook
        ? (/^https?:\/\//i.test(String(g.rulebook).trim())
            ? String(g.rulebook).trim()
            : rulebookUrl(String(g.rulebook).trim().replace(/\.pdf$/,"")))
        : rulebookUrl(slug),
      cover: coverUrl(slug)
    };

    /* --- Base quick text fields --- */
    var quickText         = (g.quickStart || "").trim();
    var remindersText     = (g.remindersText && String(g.remindersText).trim()) || "";
    var playerCountSetup  = (g.playerCountSetup || "").trim();
    var startingResources = (g.startingResources || "").trim();
    var turnStructure     = (g.turnStructure || "").trim();
    var commonMistakes    = (g.commonMistakes || "").trim();

    /* --- Dynamic player-count setup (setupByPlayerCount) --- */
    var setupByPlayerCount =
      (g.setupByPlayerCount && typeof g.setupByPlayerCount === "object")
        ? g.setupByPlayerCount
        : null;
    var hasSetupByPlayerCount =
      setupByPlayerCount && Object.keys(setupByPlayerCount).length > 0;

    var playerCountHtmlInner;
    if (hasSetupByPlayerCount) {
      var counts = Object.keys(setupByPlayerCount).sort(function(a, b) {
        return parseInt(a, 10) - parseInt(b, 10);
      });
      var first = counts[0];

      var buttonsHtml = counts.map(function(c) {
        return (
          '<button type="button" class="pc-btn" data-count="' + c + '" ' +
          (c === first ? 'data-active="true"' : "") +
          ">" + c + "p</button>"
        );
      }).join("");

      playerCountHtmlInner =
        '<div class="playercount-controls">' +
          buttonsHtml +
        "</div>" +
        '<div class="expansion-text-block">' +
          '<p id="pc-text">' +
            (setupByPlayerCount[first] || "").replace(/\n/g,"<br>") +
          "</p>" +
        "</div>";
    } else {
      playerCountHtmlInner =
        '<div class="expansion-text-block">' +
          "<p>" +
            (playerCountSetup || "(No player-count-specific setup yet.)").replace(/\n/g,"<br>") +
          "</p>" +
        "</div>";
    }

    /* --- Quick Rules Glossary --- */
    var rulesGlossary = Array.isArray(g.rulesGlossary) ? g.rulesGlossary : [];
    var rulesGlossaryHtml = "";
    if (rulesGlossary.length) {
      var glossaryItems = rulesGlossary.map(function(item) {
        var term = item.term || "";
        var desc = (item.desc || "").replace(/\n/g,"<br>");
        return (
          '<div class="glossary-item">' +
            "<dt>" + term + "</dt>" +
            "<dd>" + desc + "</dd>" +
          "</div>"
        );
      }).join("");

      rulesGlossaryHtml =
        '<section class="exp" id="rules-glossary">' +
          '<details class="expansion">' +
            '<summary><span class="expansion-name">Quick Rules Glossary</span></summary>' +
            '<div class="expansion-body">' +
              '<dl class="glossary">' +
                glossaryItems +
              "</dl>" +
            "</div>" +
          "</details>" +
        "</section>";
    }

    /* --- Player Aids (PDFs) --- */
    var playerAids = Array.isArray(g.playerAids) ? g.playerAids : [];
    var playerAidSection = "";
    if (playerAids.length) {
      var buttons = playerAids.map(function(aid, idx) {
        var label = aid.label || ("Aid " + (idx + 1));
        return (
          '<button type="button"' +
            ' class="pill-btn player-aid-btn"' +
            ' data-file="' + aid.file + '"' +
            (idx === 0 ? ' data-active="true"' : "") +
          ">" +
            label +
          "</button>"
        );
      }).join("");

      var firstFile = playerAids[0].file;

      playerAidSection =
        '<section class="exp" id="player-aids">' +
          '<details class="expansion" open>' +
            '<summary><span class="expansion-name">Player Aids (PDF)</span></summary>' +
            '<div class="expansion-body">' +
              '<div class="expansion-text-block">' +
                "<p>Quick reference PDFs for this game. Switch between aids below.</p>" +
              "</div>" +
              '<div class="player-aid-list">' +
                buttons +
              "</div>" +
              '<div class="player-aid-viewer">' +
                '<iframe' +
                  ' id="playerAidFrame"' +
                  ' src="' + firstFile + '"' +
                  ' title="Player Aid for ' + g.name + '"' +
                  ' loading="lazy">' +
                "</iframe>" +
              "</div>" +
              '<p class="expansion-text-block">' +
                '<a id="openAidLink" href="' + firstFile + '" target="_blank" rel="noopener">' +
                  "Open current aid in new tab" +
                "</a>" +
              "</p>" +
            "</div>" +
          "</details>" +
        "</section>";
    }

    /* --- Quick blocks (setup/reminders/etc.) --- */
    var quickBlocksHtml =
      '<details class="expansion" id="quick-setup-block"' + (quickText ? " open" : "") + ">" +
        '<summary><span class="expansion-name">Quick Set Up</span></summary>' +
        '<div class="expansion-body">' +
          '<div class="expansion-text-block">' +
            "<p>" + (quickText || "(No quick setup yet.)").replace(/\n/g,"<br>") + "</p>" +
          "</div>" +
        "</div>" +
      "</details>" +

      '<details class="expansion" id="reminders-block">' +
        '<summary><span class="expansion-name">Reminders</span></summary>' +
        '<div class="expansion-body">' +
          '<div class="expansion-text-block">' +
            "<p>" + (remindersText || "(No reminders yet.)").replace(/\n/g,"<br>") + "</p>" +
          "</div>" +
        "</div>" +
      "</details>" +

      '<details class="expansion" id="playercount-block">' +
        '<summary><span class="expansion-name">Player Count Setup</span></summary>' +
        '<div class="expansion-body">' +
          playerCountHtmlInner +
        "</div>" +
      "</details>" +

      '<details class="expansion" id="starting-resources-block">' +
        '<summary><span class="expansion-name">Starting Resources &amp; Setup Checklist</span></summary>' +
        '<div class="expansion-body">' +
          '<div class="expansion-text-block">' +
            "<p>" + (startingResources || "(No starting resources/checklist yet.)").replace(/\n/g,"<br>") + "</p>" +
          "</div>" +
        "</div>" +
      "</details>" +

      '<details class="expansion" id="turn-structure-block">' +
        '<summary><span class="expansion-name">Turn Structure / Phases</span></summary>' +
        '<div class="expansion-body">' +
          '<div class="expansion-text-block">' +
            "<p>" + (turnStructure || "(No turn structure summary yet.)").replace(/\n/g,"<br>") + "</p>" +
          "</div>" +
        "</div>" +
      "</details>" +

      '<details class="expansion" id="common-mistakes-block">' +
        '<summary><span class="expansion-name">Common Mistakes</span></summary>' +
        '<div class="expansion-body">' +
          '<div class="expansion-text-block">' +
            "<p>" + (commonMistakes || "(No common mistakes noted yet.)").replace(/\n/g,"<br>") + "</p>" +
          "</div>" +
        "</div>" +
      "</details>";

    /* --- Main detail markup --- */
    appEl.innerHTML =
      '<article class="detail">' +
        '<figure class="cover">' +
          '<a id="bggCoverLink" href="#" target="_blank" rel="noopener" class="cover-link">' +
            '<img src="' + links.cover + '" alt="' + g.name + ' cover" loading="lazy">' +
            '<span id="bggCoverBadge" class="cover-badge" aria-hidden="true">BGG</span>' +
          "</a>" +
        "</figure>" +
        "<div>" +
          '<h2 class="title">' + g.name + "</h2>" +
          '<p class="byline">' + (sub || "") + "</p>" +
          '<div class="actions">' +
            '<section id="qs" class="exp">' +
              (quickBlocksHtml || "<p>(No quick setup/reminders yet.)</p>") +
            "</section>" +

            renderExpansions(g) +
            playerAidSection +
            rulesGlossaryHtml +

            '<section class="exp" id="notes-section">' +
              '<details class="expansion">' +
                '<summary><span class="expansion-name">Table Notes</span></summary>' +
                '<div class="expansion-body">' +
                  '<textarea id="notes-' + slug + '" style="width:100%;height:120px;resize:vertical;" placeholder="Your personal notes for this game..."></textarea>' +
                "</div>" +
              "</details>" +
            "</section>" +

            '<a class="btnlink" data-check="rulebook" href="' + links.rulebook + '" target="_blank" rel="noopener">Open Rulebook</a>' +

            '<a class="btnlink" id="btn-bgstats" href="' + links.bgstats + '" target="_blank" rel="noopener">BG Stats - Log A Play</a>' +

            '<a class="btnlink" id="btn-youtube"' +
              (links.youtube ? (' href="' + links.youtube + '" target="_blank" rel="noopener"') : "") +
            ">How to Play Video</a>" +

            '<button class="btn" id="share">Share / Copy Link</button>' +
          "</div>" +
        "</div>" +
      "</article>";

    /* --- BGG cover link --- */
    var bggCoverLink = document.getElementById("bggCoverLink");
    var bggCoverBadge = document.getElementById("bggCoverBadge");
    if (bggCoverLink) {
      var bggUrl = bggLinkFromId(g.bggId);
      if (bggUrl) {
        bggCoverLink.href = bggUrl;
        bggCoverLink.classList.remove("cover-link--disabled");
        if (bggCoverBadge) {
          bggCoverBadge.textContent = "BoardGameGeek";
          bggCoverBadge.classList.remove("cover-badge--disabled");
        }
      } else {
        bggCoverLink.removeAttribute("href");
        bggCoverLink.style.pointerEvents = "none";
        bggCoverLink.classList.add("cover-link--disabled");
        if (bggCoverBadge) {
          bggCoverBadge.textContent = "No BGG link";
          bggCoverBadge.classList.add("cover-badge--disabled");
        }
      }
    }

    /* --- Share button --- */
    var shareBtn = document.getElementById("share");
    if (shareBtn) {
      shareBtn.addEventListener("click", function() {
        var u = window.location.href;
        if (navigator.share) {
          navigator.share({
            title: g.name,
            text: "Quick Menu - " + g.name,
            url: u
          }).catch(function() {});
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(u).then(function() {
            window.alert("Link copied");
          }).catch(function() {
            window.prompt("Copy link:", u);
          });
        } else {
          window.prompt("Copy link:", u);
        }
      });
    }

    /* --- Table notes persistence --- */
    var notesId = "notes_" + slug;
    var notesBox = document.getElementById("notes-" + slug);
    if (notesBox) {
      notesBox.value = localStorage.getItem(notesId) || "";
      notesBox.addEventListener("input", function() {
        localStorage.setItem(notesId, notesBox.value);
      });
    }

    /* --- Player Aids interactions --- */
    if (playerAids.length) {
      var frame = document.getElementById("playerAidFrame");
      var openAidLink = document.getElementById("openAidLink");
      var buttonsEls = Array.prototype.slice.call(
        document.querySelectorAll(".player-aid-btn")
      );

      if (frame && openAidLink && buttonsEls.length) {
        buttonsEls.forEach(function(btn) {
          btn.addEventListener("click", function() {
            var file = btn.getAttribute("data-file");
            if (!file) return;

            frame.src = file;
            openAidLink.href = file;

            buttonsEls.forEach(function(b) { b.removeAttribute("data-active"); });
            btn.setAttribute("data-active", "true");
          });
        });
      }
    }

    /* --- Player-count buttons interactions --- */
    if (hasSetupByPlayerCount) {
      var pcButtons = Array.prototype.slice.call(
        document.querySelectorAll(".pc-btn")
      );
      var pcTextEl = document.getElementById("pc-text");
      if (pcButtons.length && pcTextEl) {
        pcButtons.forEach(function(btn) {
          btn.addEventListener("click", function() {
            var count = btn.getAttribute("data-count");
            var text = (setupByPlayerCount[count] || "").replace(/\n/g,"<br>");
            pcTextEl.innerHTML = text || "(No details for this player count yet.)";
            pcButtons.forEach(function(b) { b.removeAttribute("data-active"); });
            btn.setAttribute("data-active", "true");
          });
        });
      }
    }

    /* --- BG Stats app-first deep link --- */
    var bgbtn = document.getElementById("btn-bgstats");
    if (bgbtn) {
      bgbtn.addEventListener("click", function(e) {
        if (!links.bgstatsApp) return; // fall back to normal web link
        e.preventDefault();
        var appUrl = links.bgstatsApp;
        var webUrl = links.bgstats;

        var timer = setTimeout(function() {
          window.open(webUrl, "_blank", "noopener");
        }, 700);

        var a = document.createElement("a");
        a.href = appUrl;
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
          try {
            document.body.removeChild(a);
          } catch (err) {}
          clearTimeout(timer);
        }, 1200);
      });
    }

    /* --- Rulebook guards + recently viewed --- */
    attachRulebookGuards();
    markRecentlyViewed(g);
  }


  function normalizeIncoming() {
    var q = qp("game");
    if (q) {
      var want = q.trim();
      var slugged = slugify(want);
      var a = (qp("action") || "quicksetup").toLowerCase();
      window.location.replace("#/game/" + slugged + "?action=" + encodeURIComponent(a));
      return true;
    }
    return false;
  }

  function parseHash() {
    var h = window.location.hash || "#/";
    var parts = h.slice(2).split("?");
    var path = parts[0] || "";
    var q = parts[1] || "";
    var pieces = path.split("/");
    var params = new URLSearchParams(q);
    if (pieces[0] === "game" && pieces[1]) {
      return {
        route: "detail",
        slug: pieces[1].toLowerCase(),
        action: (params.get("action") || "quicksetup").toLowerCase()
      };
    }
    return { route:"list" };
  }

  function render() {
    if (normalizeIncoming()) return;
    var parsed = parseHash();
    if (parsed.route === "detail") {
      renderDetail(parsed.slug, parsed.action);
    } else {
      renderList();
    }
  }

  window.addEventListener("hashchange", render);
  document.addEventListener("DOMContentLoaded", render);
})();
</script>

</body>
</html>
